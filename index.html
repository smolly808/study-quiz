<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã“ã£ã¡ã®ï¼</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; line-height: 1.5; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    label { display:block; margin: 8px 0 4px; font-weight: 600; }
    select, input[type="number"], textarea, button {
      width: 100%; font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc;
    }
    textarea { resize: vertical; min-height: 110px; }
    button { cursor: pointer; border: 0; background: #111; color: #fff; font-weight: 700; }
    button.secondary { background:#eee; color:#111; border:1px solid #ccc; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { color:#666; font-size: 13px; }
    .ok { color:#0a7; font-weight:700; }
    .ng { color:#c33; font-weight:700; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f1f1; margin-right:6px; font-size:12px; }
    .hidden { display:none !important; }
    .qbox { font-size: 20px; font-weight: 800; margin: 8px 0 10px; }
    .choices { display:grid; gap: 8px; margin: 10px 0; }
    .choiceBtn { background:#f7f7f7; color:#111; border:1px solid #ddd; text-align:left; }
    .choiceBtn.correct { border-color:#0a7; background:#eafff6; }
    .choiceBtn.wrong { border-color:#c33; background:#fff0f0; }
    .bar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:8px; }
    .kpi { font-size:13px; color:#444; }
    .fxFlash { animation: flash 0.25s ease-in-out 2; }
    @keyframes flash { 0%{transform:scale(1);} 50%{transform:scale(1.02);} 100%{transform:scale(1);} }
  </style>
</head>
<body>

  <div id="setup" class="card">
    <h2 style="margin:0 0 8px;">å­¦ç¿’ã‚¯ã‚¤ã‚º</h2>
    <div id="status" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>

    <label>æ•™ç§‘</label>
    <select id="subject">
      <option value="sci" selected>ç†ç§‘</option>
      <option value="soc">ç¤¾ä¼š</option>
      <option value="eng">è‹±èª</option>
      <option value="math">æ•°å­¦</option>
      <option value="jpn">å›½èª</option>
      <option value="pe">ä¿å¥ä½“è‚²</option>
      <option value="tech">æŠ€è¡“</option>
    </select>

    <div class="row">
      <div>
        <label>å¤§å˜å…ƒ</label>
        <select id="unitBig"></select>
      </div>
      <div>
        <label>ç¯€</label>
        <select id="unitSection"></select>
      </div>
    </div>

    <label>å‡ºé¡Œç¯„å›²</label>
    <select id="rangeMode">
      <option value="section" selected>ã“ã®ç¯€ã®ã¿</option>
      <option value="big">å¤§å˜å…ƒå…¨ä½“ï¼ˆç¯€ã‚’ã¾ãŸãï¼‰</option>
    </select>

    <div class="row">
      <div>
        <label>å•é¡Œæ•°</label>
        <input id="numQ" type="number" min="1" max="50" value="10" />
      </div>
      <div>
        <label>ã‚¿ã‚¤ãƒ—</label>
        <select id="typeFilter">
          <option value="">ã™ã¹ã¦</option>
          <option value="mcq">4æŠ</option>
          <option value="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</option>
          <option value="self">è‡ªå·±æ¡ç‚¹</option>
        </select>
      </div>
    </div>

    <label>å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</label>
    <select id="sessionMode">
      <option value="normal" selected>é€šå¸¸</option>
      <option value="wrongOnly">é–“é•ãˆãŸå•é¡Œã ã‘</option>
    </select>

    <label>å‡ºé¡Œæ–¹å¼</label>
    <select id="deliveryMode">
      <option value="random" selected>ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã¯é †ç•ªå›ºå®šã§é€£ç¶šï¼‰</option>
      <option value="sequential">é †ç•ªã«ç¶²ç¾…ï¼ˆæŒ‡å®šç¯„å›²ã‚’å…ˆé ­ã‹ã‚‰ï¼‰</option>
    </select>

    <div class="row">
      <div>
        <label>é †ç•ªç¯„å›²ï¼ˆseqï¼‰é–‹å§‹</label>
        <input id="seqFrom" type="number" min="1" placeholder="ä¾‹ï¼š1" />
      </div>
      <div>
        <label>é †ç•ªç¯„å›²ï¼ˆseqï¼‰çµ‚äº†</label>
        <input id="seqTo" type="number" min="1" placeholder="ä¾‹ï¼š50" />
      </div>
    </div>

    <label>è‹¦æ‰‹å„ªå…ˆ</label>
    <select id="weakMode">
      <option value="off">OFFï¼ˆå®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
      <option value="mid" selected>ONï¼ˆæ¨™æº–ï¼‰</option>
      <option value="strong">ONï¼ˆå¼·ã‚ï¼‰</option>
    </select>

    <label>æ¼”å‡º</label>
    <select id="fxMode">
      <option value="on" selected>ONï¼ˆåŠ¹æœéŸ³/å…‰ã‚‹/ãƒã‚¤ãƒ–/é€£ç¶šæ­£è§£ï¼‰</option>
      <option value="off">OFF</option>
    </select>

    <button id="startBtn">å‡ºé¡Œé–‹å§‹</button>
    <button class="secondary" id="reloadBtn" style="margin-top:8px;">æœ€æ–°ã®å•é¡Œè¡¨ã‚’èª­ã¿ç›´ã™</button>

    <div class="card" style="margin-top:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div>
          <div style="font-weight:800;">æˆç¸¾ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰</div>
          <div id="statsSummary" class="muted">-</div>
        </div>
        <button class="secondary" id="resetStatsBtn" style="width:auto;">æˆç¸¾ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        â€» æˆç¸¾ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>

  <div id="quiz" class="card hidden">
    <div class="bar">
      <div class="kpi">
        <span class="pill" id="kpiUnitBig">-</span>
        <span class="pill" id="kpiUnitSection">-</span>
        <span class="pill" id="kpiType">-</span>
      </div>
      <div class="kpi">
        <span id="kpiProgress">1 / 10</span>
        ãƒ»
        <span id="kpiScore">æ­£è§£ 0</span>
        ãƒ»
        <span id="kpiStreak">é€£ç¶š 0</span>
      </div>
    </div>

    <div id="qtext" class="qbox">-</div>

    <div id="mcq" class="hidden">
      <div id="choices" class="choices"></div>
      <button class="secondary" id="skipBtn">åˆ†ã‹ã‚‰ãªã„ï¼ˆä¸æ­£è§£ã§æ¬¡ã¸ï¼‰</button>
    </div>

    <div id="keyword" class="hidden">
      <label>ç­”ãˆï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰</label>
      <input id="keywordInput" type="text" placeholder="å…¥åŠ›ã—ã¦åˆ¤å®š" />
      <button id="keywordCheckBtn" style="margin-top:8px;">åˆ¤å®š</button>
      <div id="keywordHint" class="muted" style="margin-top:8px;"></div>
    </div>

    <div id="self" class="hidden">
      <label>è‡ªå·±æ¡ç‚¹ï¼ˆè‡ªåˆ†ã§ç­”ãˆã‚’è¦‹ã¦åˆ¤æ–­ï¼‰</label>
      <textarea id="selfAnswer" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã—ã¦ã‚‚OKï¼ˆä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰"></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="selfOkBtn">æ­£è§£</button>
        <button class="secondary" id="selfNgBtn">ä¸æ­£è§£</button>
      </div>
      <div id="selfReveal" class="muted" style="margin-top:8px;"></div>
    </div>

    <div style="margin-top:12px;">
      <button class="secondary" id="quitBtn">ä¸­æ–­ã—ã¦æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="result" class="card hidden">
    <h3 style="margin:0 0 6px;">çµæœ</h3>
    <div id="resultSummary"></div>
    <div id="review" style="margin-top:10px;"></div>
    <div style="margin-top:12px;">
      <button id="backBtn">è¨­å®šã¸æˆ»ã‚‹</button>
    </div>
  </div>

<script>
(() => {
  // =========================
  // è¨­å®š
  // =========================
  // â†“ã‚ãªãŸã® Apps Script Webã‚¢ãƒ—ãƒª URLï¼ˆ/execï¼‰ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„
  const API_URL = "https://script.google.com/macros/s/AKfycbyVNfQjqvEJZAKv13SOULHAqLUk2WZEFRdotZBL_aRPQDYXdklTcSojvDrMndnI3qdGsw/exec";

  const STORAGE_KEY = "quiz_stats_v1";

  // =========================
  // å–å¾—è¦ç´ 
  // =========================
  const els = {
    subject: document.getElementById('subject'),
    unitBig: document.getElementById('unitBig'),
    unitSection: document.getElementById('unitSection'),
    rangeMode: document.getElementById('rangeMode'),
    numQ: document.getElementById('numQ'),
    typeFilter: document.getElementById('typeFilter'),
    sessionMode: document.getElementById('sessionMode'),
    weakMode: document.getElementById('weakMode'),
    deliveryMode: document.getElementById('deliveryMode'),
    seqFrom: document.getElementById('seqFrom'),
    seqTo: document.getElementById('seqTo'),
    fxMode: document.getElementById('fxMode'),
    startBtn: document.getElementById('startBtn'),
    reloadBtn: document.getElementById('reloadBtn'),
    resetStatsBtn: document.getElementById('resetStatsBtn'),
    status: document.getElementById('status'),
    statsSummary: document.getElementById('statsSummary'),

    setup: document.getElementById('setup'),
    quiz: document.getElementById('quiz'),
    result: document.getElementById('result'),

    kpiUnitBig: document.getElementById('kpiUnitBig'),
    kpiUnitSection: document.getElementById('kpiUnitSection'),
    kpiType: document.getElementById('kpiType'),
    kpiProgress: document.getElementById('kpiProgress'),
    kpiScore: document.getElementById('kpiScore'),
    kpiStreak: document.getElementById('kpiStreak'),

    qtext: document.getElementById('qtext'),

    mcq: document.getElementById('mcq'),
    choices: document.getElementById('choices'),
    skipBtn: document.getElementById('skipBtn'),

    keyword: document.getElementById('keyword'),
    keywordInput: document.getElementById('keywordInput'),
    keywordCheckBtn: document.getElementById('keywordCheckBtn'),
    keywordHint: document.getElementById('keywordHint'),

    self: document.getElementById('self'),
    selfAnswer: document.getElementById('selfAnswer'),
    selfOkBtn: document.getElementById('selfOkBtn'),
    selfNgBtn: document.getElementById('selfNgBtn'),
    selfReveal: document.getElementById('selfReveal'),

    quitBtn: document.getElementById('quitBtn'),
    backBtn: document.getElementById('backBtn'),

    resultSummary: document.getElementById('resultSummary'),
    review: document.getElementById('review'),
  };

  // =========================
  // çŠ¶æ…‹
  // =========================
  let catalog = [];         // ç¾åœ¨æ•™ç§‘ã®å…¨å•é¡Œ
  let allForSubject = [];   // åŒä¸Š
  let quizList = [];        // ä»Šå›ã®å‡ºé¡Œãƒªã‚¹ãƒˆ
  let idx = 0;
  let correct = 0;
  let results = [];
  let streak = 0;
  let bestStreak = 0;

  // =========================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // =========================
  const show = (el, on) => el.classList.toggle('hidden', !on);

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function nowMs() { return Date.now(); }

  function loadStats() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveStats(stats) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
    renderStatsSummary();
  }

  function renderStatsSummary() {
    const stats = loadStats();
    let ok = 0, ng = 0;
    Object.values(stats).forEach(s => {
      ok += Number(s.ok || 0);
      ng += Number(s.ng || 0);
    });
    const total = ok + ng;
    const rate = total ? Math.round(ok * 1000 / total) / 10 : 0;
    els.statsSummary.textContent = `å›ç­” ${total}å›ï¼ˆæ­£è§£ ${ok} / ä¸æ­£è§£ ${ng}ï¼‰ æ­£ç­”ç‡ ${rate}%`;
  }

  function resetStats() {
    if (!confirm("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderStatsSummary();
    alert("æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
  }

  function recordResult(q, ok) {
    const id = String(q.id ?? "");
    if (!id) return;
    const stats = loadStats();
    const s = stats[id] || { ok: 0, ng: 0, lastAt: 0 };
    if (ok) s.ok = (s.ok || 0) + 1;
    else s.ng = (s.ng || 0) + 1;
    s.lastAt = nowMs();
    stats[id] = s;
    saveStats(stats);
  }

  function isWrongQuestion(q) {
    const id = String(q.id ?? "");
    if (!id) return false;
    const s = loadStats()[id];
    return !!(s && (s.ng || 0) > 0);
  }

  function weightForQuestion(q, mode) {
    if (mode === "off") return 1;

    const stats = loadStats();
    const id = String(q.id ?? "");
    const s = stats[id] || { ok: 0, ng: 0, lastAt: 0 };

    const ok = Number(s.ok || 0);
    const ng = Number(s.ng || 0);
    const total = ok + ng;
    const wrongRate = total ? (ng / total) : 0.4; // åˆå›ã¯å°‘ã—é«˜ã‚
    const ageDays = s.lastAt ? ( (nowMs() - s.lastAt) / (1000*60*60*24) ) : 999;

    // æœ€è¿‘ã‚„ã£ã¦ãªã„ã»ã©é‡ãã€é–“é•ãˆã‚„ã™ã„ã»ã©é‡ã
    let w = 1;
    w *= (1 + wrongRate * (mode === "strong" ? 3.0 : 1.8));
    w *= Math.min(2.0, 1 + ageDays / (mode === "strong" ? 3 : 6));
    return Math.max(0.2, w);
  }

  function sampleWeightedUnique(pool, n, mode) {
    const items = pool.map(q => ({ q, w: weightForQuestion(q, mode) }));
    const picked = [];
    const N = Math.min(n, items.length);

    for (let i = 0; i < N; i++) {
      const sum = items.reduce((a, x) => a + x.w, 0);
      let r = Math.random() * sum;
      let idx = -1;
      for (let j = 0; j < items.length; j++) {
        r -= items[j].w;
        if (r <= 0) { idx = j; break; }
      }
      if (idx < 0) idx = items.length - 1;
      picked.push(items[idx].q);
      items.splice(idx, 1);
    }
    return picked;
  }

  // =========================
  // ã‚°ãƒ«ãƒ¼ãƒ—å¯¾å¿œï¼ˆgroup_id / group_orderï¼‰
  // - ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸ã§ã‚‚ã€ã‚°ãƒ«ãƒ¼ãƒ—ã¯å¿…ãšé€£ç¶šï¼†é †ç•ªå›ºå®šã§å‡ºé¡Œã™ã‚‹
  // - sequentialï¼ˆé †ç•ªã«ç¶²ç¾…ï¼‰ã§ã‚‚ã€ã‚°ãƒ«ãƒ¼ãƒ—ã¯é€£çµã—ã¦é †ç•ªå›ºå®š
  // =========================
  function toNumberOrFallback(v, fb) {
    const n = Number(v);
    return Number.isFinite(n) ? n : fb;
  }

  function filterBySeqRange(pool, fromSeq, toSeq) {
    const f = Number(fromSeq);
    const t = Number(toSeq);
    const hasF = Number.isFinite(f) && f > 0;
    const hasT = Number.isFinite(t) && t > 0;
    if (!hasF && !hasT) return pool;

    return pool.filter(q => {
      const s = Number(q.seq);
      if (!Number.isFinite(s)) return false; // seqæœªè¨­å®šã¯é™¤å¤–ï¼ˆå«ã‚ãŸã„ãªã‚‰ true ã«å¤‰æ›´ï¼‰
      if (hasF && s < f) return false;
      if (hasT && s > t) return false;
      return true;
    });
  }

  function buildUnitsFromPool(pool, weakMode) {
    const groupMap = new Map(); // group_id -> [q...]
    const singles = [];

    for (const q of pool) {
      const gid = String(q.group_id || "").trim();
      if (!gid) {
        singles.push(q);
      } else {
        if (!groupMap.has(gid)) groupMap.set(gid, []);
        groupMap.get(gid).push(q);
      }
    }

    const units = [];

    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¦ãƒ‹ãƒƒãƒˆï¼ˆgroup_orderã§ä¸¦ã¶ï¼‰
    for (const [gid, arr] of groupMap.entries()) {
      arr.sort((a, b) => toNumberOrFallback(a.group_order, 999999) - toNumberOrFallback(b.group_order, 999999));

      // è‹¦æ‰‹å„ªå…ˆï¼šã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€Œä¸­ã§ä¸€ç•ªé‡ã„ï¼ˆå‡ºã‚„ã™ã„ï¼‰ã€ã‚’æ¡ç”¨ï¼ˆå¥½ã¿ã«å¿œã˜ã¦å¹³å‡ã§ã‚‚OKï¼‰
      const w = Math.max(...arr.map(q => weightForQuestion(q, weakMode)));

      units.push({
        key: `G:${gid}`,
        items: arr,
        weight: w,
        isGroup: true,
        group_id: gid
      });
    }

    // å˜ç‹¬ãƒ¦ãƒ‹ãƒƒãƒˆ
    for (const q of singles) {
      units.push({
        key: `Q:${String(q.id ?? Math.random())}`,
        items: [q],
        weight: weightForQuestion(q, weakMode),
        isGroup: false
      });
    }

    return units;
  }

  function sampleWeightedUniqueUnits(units, nUnits) {
    const items = units.map(u => ({ u, w: Math.max(0.2, Number(u.weight || 1)) }));
    const picked = [];
    const N = Math.min(nUnits, items.length);

    for (let i = 0; i < N; i++) {
      const sum = items.reduce((a, x) => a + x.w, 0);
      let r = Math.random() * sum;
      let idx = -1;
      for (let j = 0; j < items.length; j++) {
        r -= items[j].w;
        if (r <= 0) { idx = j; break; }
      }
      if (idx < 0) idx = items.length - 1;
      picked.push(items[idx].u);
      items.splice(idx, 1);
    }
    return picked;
  }

  function sortPoolSequentialWithGroups(pool) {
    // group_idã§ã¾ã¨ã‚ã¦ãƒ¦ãƒ‹ãƒƒãƒˆåŒ–ï¼ˆå˜ç‹¬ã¯1å•ãƒ¦ãƒ‹ãƒƒãƒˆï¼‰
    const groups = new Map(); // key -> [q...]
    for (const q of pool) {
      const gid = String(q.group_id || "").trim();
      if (gid) {
        const key = `G:${gid}`;
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(q);
      } else {
        const key = `Q:${String(q.id ?? Math.random())}`;
        groups.set(key, [q]);
      }
    }

    const units = [];
    for (const [key, arr] of groups.entries()) {
      if (key.startsWith("G:")) {
        arr.sort((a, b) => toNumberOrFallback(a.group_order, 999999) - toNumberOrFallback(b.group_order, 999999));
      }
      const first = arr[0];

      // ä¸¦ã³ã®åŸºæº–ï¼šseqï¼ˆæ¨å¥¨ï¼‰â†’ unit_big_order â†’ unit_section_order â†’ id
      const seq = toNumberOrFallback(first.seq, 999999);
      const bigO = toNumberOrFallback(first.unit_big_order, 999999);
      const secO = toNumberOrFallback(first.unit_section_order, 999999);
      const idO  = toNumberOrFallback(first.id, 999999);

      units.push({ key, items: arr, seq, bigO, secO, idO });
    }

    units.sort((a, b) => {
      if (a.seq !== b.seq) return a.seq - b.seq;
      if (a.bigO !== b.bigO) return a.bigO - b.bigO;
      if (a.secO !== b.secO) return a.secO - b.secO;
      return a.idO - b.idO;
    });

    return units.flatMap(u => u.items);
  }

  function hasWrongInGroup(pool, gid) {
    const g = String(gid || "").trim();
    if (!g) return false;
    return pool.some(q => String(q.group_id || "").trim() === g && isWrongQuestion(q));
  }

  // =========================
  // UI
  // =========================
  function uniq(arr) {
    return Array.from(new Set(arr.filter(Boolean)));
  }

  function uniqSortBigUnits(list) {
    // unit_big_order ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ–‡å­—é †
    const map = new Map();
    list.forEach(q => {
      const k = String(q.unit_big || "").trim();
      if (!k) return;
      if (!map.has(k)) map.set(k, { name: k, order: Number(q.unit_big_order) });
    });
    const items = Array.from(map.values());
    items.sort((a, b) => {
      const ao = Number.isFinite(a.order) ? a.order : 999999;
      const bo = Number.isFinite(b.order) ? b.order : 999999;
      if (ao !== bo) return ao - bo;
      return a.name.localeCompare(b.name, "ja");
    });
    return items.map(x => x.name);
  }

  function uniqSortSections(list, big) {
    const map = new Map();
    list.forEach(q => {
      if (!eqIgnoreCase(q.unit_big, big)) return;
      const k = String(q.unit_section || "").trim();
      if (!k) return;
      if (!map.has(k)) map.set(k, { name: k, order: Number(q.unit_section_order) });
    });
    const items = Array.from(map.values());
    items.sort((a, b) => {
      const ao = Number.isFinite(a.order) ? a.order : 999999;
      const bo = Number.isFinite(b.order) ? b.order : 999999;
      if (ao !== bo) return ao - bo;
      return a.name.localeCompare(b.name, "ja");
    });
    return items.map(x => x.name);
  }

  function eqIgnoreCase(a, b) {
    return String(a || '').trim().toLowerCase() === String(b || '').trim().toLowerCase();
  }

  function currentPool() {
    const subject = els.subject.value;
    const big = els.unitBig.value;
    const sec = els.unitSection.value;
    const rangeMode = els.rangeMode.value;
    const type = els.typeFilter.value;

    let pool = catalog.filter(q => eqIgnoreCase(q.subject, subject));

    if (rangeMode === "section") {
      pool = pool.filter(q => eqIgnoreCase(q.unit_big, big) && eqIgnoreCase(q.unit_section, sec));
    } else {
      pool = pool.filter(q => eqIgnoreCase(q.unit_big, big));
    }

    if (type) pool = pool.filter(q => eqIgnoreCase(q.type, type));

    return pool;
  }

  function setOptions(selectEl, options) {
    selectEl.innerHTML = options.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
  }

  async function loadCatalog() {
    els.status.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
    const subject = els.subject.value;

    const url = `${API_URL}?subject=${encodeURIComponent(subject)}&callback=cb`;
    const data = await jsonp(url);

    const list = (data && data.data) ? data.data : [];
    catalog = list;
    allForSubject = list;

    // big / section ã‚’ã‚»ãƒƒãƒˆ
    const bigUnits = uniqSortBigUnits(allForSubject);
    setOptions(els.unitBig, bigUnits);

    const big = els.unitBig.value;
    const sections = uniqSortSections(allForSubject, big);
    setOptions(els.unitSection, sections);

    els.status.textContent = `èª­è¾¼å®Œäº†ï¼š${list.length}å•ï¼ˆæ•™ç§‘ï¼š${subject}ï¼‰`;
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(16).slice(2);
      const u = url.replace("callback=cb", "callback=" + cbName);

      const script = document.createElement("script");
      script.src = u;
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP load failed"));
      };

      function cleanup() {
        delete window[cbName];
        script.remove();
      }

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      document.body.appendChild(script);
    });
  }

  function playFx(ok) {
    if (els.fxMode.value !== "on") return;
    try {
      if (navigator.vibrate) navigator.vibrate(ok ? 50 : [60, 30, 60]);
    } catch {}
    els.quiz.classList.add("fxFlash");
    setTimeout(() => els.quiz.classList.remove("fxFlash"), 600);
  }

  function renderQuestion(q) {
    if (!q) return finish();

    const total = quizList.length;
    els.kpiProgress.textContent = `${idx + 1} / ${total}`;
    els.kpiScore.textContent = `æ­£è§£ ${correct}`;
    els.kpiStreak.textContent = `é€£ç¶š ${streak}`;

    els.kpiUnitBig.textContent = q.unit_big ? `å¤§å˜å…ƒï¼š${q.unit_big}` : "-";
    els.kpiUnitSection.textContent = q.unit_section ? `ç¯€ï¼š${q.unit_section}` : "-";
    els.kpiType.textContent = q.type ? `ã‚¿ã‚¤ãƒ—ï¼š${q.type}` : "-";

    els.qtext.textContent = q.q || q.question || "(å•é¡Œæ–‡ãªã—)";

    // type åˆ‡ã‚Šæ›¿ãˆ
    show(els.mcq, false);
    show(els.keyword, false);
    show(els.self, false);

    if (eqIgnoreCase(q.type, "mcq")) renderMcq(q);
    else if (eqIgnoreCase(q.type, "keyword")) renderKeyword(q);
    else renderSelf(q);
  }

  function renderMcq(q) {
    show(els.mcq, true);

    const choices = [q.a, q.b, q.c, q.d].filter(x => String(x || "").trim() !== "");
    els.choices.innerHTML = "";

    choices.forEach((c, i) => {
      const btn = document.createElement("button");
      btn.className = "choiceBtn";
      btn.textContent = c;
      btn.onclick = () => {
        const correctIndex = Number(q.correct_index);
        const ok = Number.isFinite(correctIndex) ? (i === correctIndex) : (String(c).trim() === String(q.answer || "").trim());

        if (ok) btn.classList.add("correct");
        else btn.classList.add("wrong");

        finalizeAnswer(q, ok);
      };
      els.choices.appendChild(btn);
    });

    els.skipBtn.onclick = () => finalizeAnswer(q, false);
  }

  function renderKeyword(q) {
    show(els.keyword, true);
    els.keywordInput.value = "";
    els.keywordHint.textContent = q.hint ? `ãƒ’ãƒ³ãƒˆï¼š${q.hint}` : "";

    els.keywordCheckBtn.onclick = () => {
      const input = String(els.keywordInput.value || "").trim();
      const ans = String(q.answer || "").trim();
      const ok = input && ans && eqIgnoreCase(input, ans);
      finalizeAnswer(q, ok);
    };
  }

  function renderSelf(q) {
    show(els.self, true);
    els.selfAnswer.value = "";
    els.selfReveal.textContent = q.answer ? `ç­”ãˆï¼š${q.answer}` : "";

    els.selfOkBtn.onclick = () => finalizeAnswer(q, true);
    els.selfNgBtn.onclick = () => finalizeAnswer(q, false);
  }

  function finalizeAnswer(q, ok) {
    recordResult(q, ok);
    results.push({
      ok,
      unit_big: q.unit_big,
      unit_section: q.unit_section,
      q: q.q || q.question || "",
      type: q.type || ""
    });

    if (ok) {
      correct++;
      streak++;
      bestStreak = Math.max(bestStreak, streak);
    } else {
      streak = 0;
    }

    playFx(ok);

    idx++;
    if (idx >= quizList.length) return finish();
    setTimeout(() => renderQuestion(quizList[idx]), 250);
  }

  function finish() {
    show(els.quiz, false);
    show(els.result, true);

    const total = quizList.length;
    const rate = total ? Math.round(correct * 1000 / total) / 10 : 0;

    els.resultSummary.innerHTML = `
      <div>æ­£è§£ï¼š<b>${correct}</b> / ${total}ï¼ˆæ­£ç­”ç‡ ${rate}%ï¼‰</div>
      <div class="muted">æœ€å¤§é€£ç¶šæ­£è§£ï¼š${bestStreak}</div>
    `;

    const wrongs = results.filter(r => !r.ok);
    if (wrongs.length === 0) {
      els.review.innerHTML = `<div class="ok">ğŸ‰ å…¨å•æ­£è§£ï¼</div>`;
    } else {
      els.review.innerHTML =
        `<div class="ng">é–“é•ã„ï¼š${wrongs.length}å•</div>` +
        `<ol>${wrongs.map(w => `<li>${escapeHtml(w.unit_big||"")} / ${escapeHtml(w.unit_section||"")}ï¼š${escapeHtml(w.q||"")}</li>`).join("")}</ol>`;
    }
  }

  function startQuiz() {
    let pool = currentPool();

    const n = Math.max(1, Math.min(50, Number(els.numQ.value || 10)));
    const weakMode = els.weakMode.value;
    const sessionMode = els.sessionMode.value;
    const deliveryMode = (els.deliveryMode && els.deliveryMode.value) ? els.deliveryMode.value : "random";

    // seq ç¯„å›²ï¼ˆä»»æ„ï¼‰
    const seqFrom = els.seqFrom ? els.seqFrom.value : "";
    const seqTo   = els.seqTo   ? els.seqTo.value   : "";
    pool = filterBySeqRange(pool, seqFrom, seqTo);

    if (pool.length === 0) {
      alert("ã“ã®æ¡ä»¶ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å•é¡Œã‚’è¿½åŠ ã™ã‚‹ã‹ã€æ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚");
      return;
    }

    // é–“é•ã„ã ã‘
    if (sessionMode === "wrongOnly") {
      // å˜ç‹¬ï¼šé–“é•ãˆãŸå•é¡Œã ã‘
      // ã‚°ãƒ«ãƒ¼ãƒ—ï¼šã‚°ãƒ«ãƒ¼ãƒ—å†…ã«1å•ã§ã‚‚é–“é•ã„ãŒã‚ã‚Œã°ã€ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ä¸¸ã”ã¨å‡ºã™
      const filtered = pool.filter(q => {
        const gid = String(q.group_id || "").trim();
        if (!gid) return isWrongQuestion(q);
        return hasWrongInGroup(pool, gid);
      });

      if (filtered.length === 0) {
        alert("ã“ã®ç¯„å›²ã§ã¯ã€Œé–“é•ãˆãŸå•é¡Œã€ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§è§£ã„ã¦å±¥æ­´ã‚’ä½œã£ã¦ãã ã•ã„ã€‚");
        return;
      }
      pool = filtered;
    }

    if (deliveryMode === "sequential") {
      // â˜…é †ç•ªã«ç¶²ç¾…ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã¯é€£çµï¼†é †ç•ªå›ºå®šï¼‰
      quizList = sortPoolSequentialWithGroups(pool);

      // â€»ç¶²ç¾…ãƒ¢ãƒ¼ãƒ‰ã§ã¯ numQ ã¯ç„¡è¦–ã—ã¦å…¨å•å‡ºã—ã¾ã™
      // ã‚‚ã—ã€Œæœ€åˆã®Nå•ã ã‘ã€ã‚‚æ¬²ã—ã„å ´åˆã¯ä¸‹ã‚’æœ‰åŠ¹åŒ–
      // quizList = quizList.slice(0, n);

    } else {
      // â˜…ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆæŠ½é¸å˜ä½ã‚’ãƒ¦ãƒ‹ãƒƒãƒˆåŒ–ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã¯åˆ‡ã‚‰ãšé€£çµï¼‰
      const units = buildUnitsFromPool(pool, weakMode);
      const pickedUnits = sampleWeightedUniqueUnits(units, units.length);

      // nå•ã«è¿‘ã¥ã‘ã‚‹ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã¯åŸå‰‡åˆ‡ã‚‰ãªã„ï¼‰
      const final = [];
      for (const u of pickedUnits) {
        if (final.length >= n) break;

        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é€”ä¸­ã§åˆ‡ã‚ŠãŸããªã„ã®ã§ã€ã¯ã¿å‡ºã™ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (u.isGroup && final.length + u.items.length > n) continue;

        final.push(...u.items);
      }

      // ã©ã†ã—ã¦ã‚‚åŸ‹ã¾ã‚‰ãªã„æ™‚ã®ä¿é™ºï¼šãƒ¦ãƒ‹ãƒƒãƒˆã‚’å¹³å¦åŒ–ã—ã¦å…ˆé ­ã‹ã‚‰nå•
      if (final.length === 0) {
        const flat = pickedUnits.flatMap(u => u.items);
        quizList = flat.slice(0, n);
      } else {
        quizList = final;
      }
    }

    idx = 0;
    correct = 0;
    results = [];
    streak = 0;
    bestStreak = 0;

    show(els.setup, false);
    show(els.result, false);
    show(els.quiz, true);

    renderQuestion(quizList[0]);
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  els.reloadBtn.onclick = () => loadCatalog().catch(e => els.status.textContent = "èª­è¾¼å¤±æ•—ï¼š" + e.message);
  els.subject.onchange = () => loadCatalog().catch(e => els.status.textContent = "èª­è¾¼å¤±æ•—ï¼š" + e.message);

  els.unitBig.onchange = () => {
    const big = els.unitBig.value;
    const sections = uniqSortSections(allForSubject, big);
    els.unitSection.innerHTML = sections.length
      ? sections.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("")
      : `<option value="">(ç¯€ãªã—)</option>`;
  };

  els.startBtn.onclick = () => startQuiz();

  els.quitBtn.onclick = () => {
    if (!confirm("ä¸­æ–­ã—ã¦è¨­å®šç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) return;
    show(els.quiz, false);
    show(els.result, false);
    show(els.setup, true);
  };

  els.backBtn.onclick = () => {
    show(els.result, false);
    show(els.setup, true);
  };

  els.resetStatsBtn.onclick = () => resetStats();

  // åˆæœŸåŒ–
  renderStatsSummary();
  loadCatalog().catch(e => els.status.textContent = "èª­è¾¼å¤±æ•—ï¼š" + e.message);
})();
</script>

</body>
</html>




