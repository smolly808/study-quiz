<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家庭学習クイズ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; line-height: 1.5; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    label { display:block; margin: 8px 0 4px; font-weight: 600; }
    select, input[type="number"], button { width: 100%; font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { border: none; background: #111; color: #fff; margin-top: 10px; }
    button.secondary { background: #666; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .muted { color:#666; font-size: 13px; }
  </style>
</head>
<body>

<h2>家庭学習クイズ（単元選択）</h2>
<div class="muted">科目→大単元→節が表示できれば成功。次の段階で出題画面を追加します。</div>

<div class="card">
  <label>科目</label>
  <select id="subject">
    <option value="history">歴史</option>
    <option value="geography">地理</option>
    <option value="science">理科</option>
    <option value="art">美術</option>
    <option value="music">音楽</option>
    <option value="pe">保健体育</option>
    <option value="tech">技術</option>
  </select>

  <div class="row">
    <div>
      <label>大単元</label>
      <select id="unitBig"></select>
    </div>
    <div>
      <label>節</label>
      <select id="unitSection"></select>
    </div>
  </div>

  <button id="reloadBtn" class="secondary">再読み込み</button>
  <div class="muted" id="status"></div>
</div>

<script>
  // ★ここをあなたの exec URL に置き換え
  const API_BASE = "https://script.google.com/macros/s/AKfycbyVNfQjqvEJZAKv13SOULHAqLUk2WZEFRdotZBL_aRPQDYXdklTcSojvDrMndnI3qdGsw/exec";

  const els = {
    subject: document.getElementById('subject'),
    unitBig: document.getElementById('unitBig'),
    unitSection: document.getElementById('unitSection'),
    reloadBtn: document.getElementById('reloadBtn'),
    status: document.getElementById('status')
  };

  let allForSubject = [];

  function qs(params) {
    const u = new URL(API_BASE);
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && String(v).trim() !== "") u.searchParams.set(k, v);
    });
    // キャッシュ回避
    u.searchParams.set("_t", Date.now().toString());
    return u.toString();
  }

  // JSONP（CORS回避）
  function fetchJSONP(url) {
    return new Promise((resolve, reject) => {
      const cbName = "jsonp_cb_" + Math.random().toString(36).slice(2);
      const u = new URL(url);
      u.searchParams.set("callback", cbName);

      const script = document.createElement("script");
      script.src = u.toString();

      window[cbName] = (data) => { cleanup(); resolve(data); };
      script.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };

      function cleanup() { delete window[cbName]; script.remove(); }
      document.body.appendChild(script);
    });
  }

  function uniqSortUnits(items) {
    const map = new Map();
    for (const it of items) {
      const name = (it.unit_big ?? "").toString().trim();
      if (!name) continue;
      const order = Number(it.unit_big_order);
      if (!map.has(name)) map.set(name, {name, order: Number.isFinite(order) ? order : 9999});
    }
    return Array.from(map.values())
      .sort((a,b) => a.order - b.order || a.name.localeCompare(b.name,'ja'))
      .map(x => x.name);
  }

  function uniqSortSections(items, unitBig) {
    const map = new Map();
    for (const it of items) {
      const big = (it.unit_big ?? "").toString().trim();
      if (big !== unitBig) continue;
      const sec = (it.unit_section ?? "").toString().trim();
      if (!sec) continue;
      const order = Number(it.unit_section_order);
      if (!map.has(sec)) map.set(sec, {sec, order: Number.isFinite(order) ? order : 9999});
    }
    return Array.from(map.values())
      .sort((a,b) => a.order - b.order || a.sec.localeCompare(b.sec,'ja'))
      .map(x => x.sec);
  }

  async function loadCatalog() {
    els.status.textContent = "読み込み中…";
    const subject = els.subject.value;

    const json = await fetchJSONP(qs({ subject }));
    allForSubject = json.data || [];

    const unitBigs = uniqSortUnits(allForSubject);
    els.unitBig.innerHTML = unitBigs.length
      ? unitBigs.map(u => `<option value="${u}">${u}</option>`).join("")
      : `<option value="">（問題なし）</option>`;

    const firstBig = unitBigs[0] || "";
    const sections = uniqSortSections(allForSubject, firstBig);
    els.unitSection.innerHTML = sections.length
      ? sections.map(s => `<option value="${s}">${s}</option>`).join("")
      : `<option value="">（節なし）</option>`;

    els.status.textContent = `読み込み完了：${json.count}件（科目=${subject}）`;
  }

  els.reloadBtn.onclick = () => loadCatalog().catch(e => els.status.textContent = "読込失敗：" + e.message);

  els.subject.onchange = () => loadCatalog().catch(e => els.status.textContent = "読込失敗：" + e.message);

  els.unitBig.onchange = () => {
    const big = els.unitBig.value;
    const sections = uniqSortSections(allForSubject, big);
    els.unitSection.innerHTML = sections.length
      ? sections.map(s => `<option value="${s}">${s}</option>`).join("")
      : `<option value="">（節なし）</option>`;
  };

  loadCatalog().catch(e => els.status.textContent = "初期読込失敗：" + e.message);
</script>
</body>
</html>


