<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å®¶åº­å­¦ç¿’ã‚¯ã‚¤ã‚º</title>

<style>
body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; line-height: 1.5; }
.card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
label { display:block; margin: 8px 0 4px; font-weight: 600; }
select, input[type="number"], textarea, button {
  width: 100%; font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc;
}
textarea { resize: vertical; }
button { border: none; background: #111; color: #fff; margin-top: 10px; }
button.secondary { background: #666; }
button.danger { background:#b00020; }
button:disabled { background:#ccc; color:#777; }
.row { display:flex; gap:10px; }
.row > * { flex:1; }
.muted { color:#666; font-size: 13px; }
.pill { display:inline-block; padding: 2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; margin-right:6px; }
.choices button { background:#f3f3f3; color:#111; border:1px solid #ddd; margin: 8px 0; text-align:left; }
hr { border:none; border-top:1px solid #eee; margin:12px 0; }

.ok { color: #00c853; font-weight: 900; font-size: 30px; }
.ng { color: #ff1744; font-weight: 900; font-size: 22px; }

.q-image { max-width: 100%; border-radius: 12px; border: 1px solid #eee; margin:10px 0; }

.table { width:100%; border-collapse: collapse; margin-top:8px; }
.table th, .table td { border-bottom:1px solid #eee; padding:8px; font-size:14px; text-align:left; }
.table th { background:#fafafa; }
.badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
</style>
</head>

<body>

<h2>å®¶åº­å­¦ç¿’ã‚¯ã‚¤ã‚º</h2>

<div class="card" id="setup">

<label>ç§‘ç›®</label>
<select id="subject">
  <option value="history">æ­´å²</option>
  <option value="geography">åœ°ç†</option>
  <option value="science">ç†ç§‘</option>
  <option value="art">ç¾è¡“</option>
  <option value="music">éŸ³æ¥½</option>
  <option value="pe">ä¿å¥ä½“è‚²</option>
  <option value="tech">æŠ€è¡“</option>
</select>

<div class="row">
  <div>
    <label>å¤§å˜å…ƒ</label>
    <select id="unitBig"></select>
  </div>
  <div>
    <label>ç¯€</label>
    <select id="unitSection"></select>
  </div>
</div>

<label>å‡ºé¡Œç¯„å›²</label>
<select id="rangeMode">
  <option value="section">ã“ã®ç¯€ã®ã¿</option>
  <option value="big">å¤§å˜å…ƒå…¨ä½“</option>
</select>

<label>å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</label>
<select id="sessionMode">
  <option value="normal">é€šå¸¸</option>
  <option value="wrongOnly">é–“é•ãˆãŸå•é¡Œã ã‘</option>
</select>

<button id="startBtn">å‡ºé¡Œé–‹å§‹</button>
<button class="danger" id="resetStatsBtn">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>

<hr/>

<h3>ğŸ“Š å­¦ç¿’åˆ†æ</h3>
<button class="secondary" id="analyticsBtn">åˆ†æã‚’è¡¨ç¤º</button>
<div id="analyticsStatus" class="muted"></div>

<div id="analyticsCard" style="display:none;">
  <h4>æ•™ç§‘åˆ¥ å­¦ç¿’å›æ•°</h4>
  <canvas id="chartSubject" width="360" height="200" style="width:100%; border:1px solid #eee;"></canvas>

  <h4 style="margin-top:12px;">ç¯€åˆ¥ å­¦ç¿’å›æ•°ï¼ˆé¸æŠä¸­ã®æ•™ç§‘ï¼‰</h4>
  <canvas id="chartSection" width="360" height="220" style="width:100%; border:1px solid #eee;"></canvas>

  <h4 style="margin-top:12px;">ä¸å¾—æ„ãªç¯€ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
  <div id="weakSections"></div>
</div>

</div>

<!-- å‡ºé¡Œ -->
<div class="card" id="quiz" style="display:none;">
  <div id="progress" class="muted"></div>
  <div id="meta"></div>
  <h3 id="qText"></h3>

  <div id="mcqArea"></div>
  <div id="feedback"></div>

  <button class="secondary" id="nextBtn" style="display:none;">æ¬¡ã®å•é¡Œ</button>
  <button class="secondary" id="quitBtn">çµ‚äº†</button>
</div>

<script>
const API_BASE = "ã‚ãªãŸã®execURL";

// ===== å±¥æ­´ =====
const STATS_KEY = "quiz_stats_v1";
function loadStats(){ try{return JSON.parse(localStorage.getItem(STATS_KEY)||"{}");}catch{return{};} }
function saveStats(s){ localStorage.setItem(STATS_KEY,JSON.stringify(s)); }
function recordAttempt(q,ok){
  const stats=loadStats();
  const id=String(q.id||"");
  if(!stats[id]) stats[id]={ok:0,ng:0};
  ok?stats[id].ok++:stats[id].ng++;
  saveStats(stats);
}

// ===== è¦ç´  =====
const els={
subject:subject, unitBig:unitBig, unitSection:unitSection,
rangeMode:rangeMode, sessionMode:sessionMode,
startBtn:startBtn, resetStatsBtn:resetStatsBtn,
analyticsBtn:analyticsBtn, analyticsCard:analyticsCard,
analyticsStatus:analyticsStatus,
chartSubject:chartSubject, chartSection:chartSection,
weakSections:weakSections,

setup:setup, quiz:quiz,
progress:progress, meta:meta, qText:qText,
mcqArea:mcqArea, feedback:feedback,
nextBtn:nextBtn, quitBtn:quitBtn
};

let allForSubject=[];
let quizList=[];
let idx=0;
let correct=0;

// ===== JSONP =====
function qs(params){
  const u=new URL(API_BASE);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  u.searchParams.set("_t",Date.now());
  return u.toString();
}
function fetchJSONP(url){
  return new Promise((resolve)=>{
    const cb="cb"+Math.random().toString(36).slice(2);
    window[cb]=(d)=>{script.remove();resolve(d);};
    const script=document.createElement("script");
    script.src=url+"&callback="+cb;
    document.body.appendChild(script);
  });
}

// ===== èª­è¾¼ =====
async function loadCatalog(){
  const json=await fetchJSONP(qs({subject:els.subject.value}));
  allForSubject=json.data||[];
}
loadCatalog();
els.subject.onchange=loadCatalog;

// ===== å‡ºé¡Œ =====
function startQuiz(){
  let pool=allForSubject;
  if(els.sessionMode.value==="wrongOnly"){
    const stats=loadStats();
    pool=pool.filter(q=>stats[String(q.id||"")]?.ng>0);
  }
  if(pool.length===0){alert("å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“");return;}

  quizList=pool.sort(()=>Math.random()-0.5).slice(0,10);
  idx=0;correct=0;
  els.setup.style.display="none";
  els.quiz.style.display="";
  renderQuestion(quizList[0]);
}
els.startBtn.onclick=startQuiz;

function renderQuestion(q){
  els.progress.textContent=`å•é¡Œ ${idx+1}/${quizList.length}`;
  els.meta.textContent=q.unit_big+" / "+q.unit_section;
  els.qText.textContent=q.question;

  els.mcqArea.innerHTML="";
  [["A",q.choice_a],["B",q.choice_b],["C",q.choice_c],["D",q.choice_d]].forEach(([k,v])=>{
    if(!v)return;
    const b=document.createElement("button");
    b.textContent=k+" "+v;
    b.onclick=()=>{
      const ok=k===q.correct;
      els.feedback.innerHTML=ok?'<div class="ok">æ­£è§£ï¼</div>':'<div class="ng">ä¸æ­£è§£</div>';
      if(ok)correct++;
      recordAttempt(q,ok);
      els.nextBtn.style.display="";
    };
    els.mcqArea.appendChild(b);
  });
}
els.nextBtn.onclick=()=>{
  idx++;
  if(idx>=quizList.length){alert(`çµ‚äº† ${correct}/${quizList.length}`);location.reload();return;}
  els.feedback.innerHTML="";
  els.nextBtn.style.display="none";
  renderQuestion(quizList[idx]);
};
els.quitBtn.onclick=()=>location.reload();

els.resetStatsBtn.onclick=()=>{
  if(confirm("å±¥æ­´ã‚’æ¶ˆã™ï¼Ÿ")){localStorage.removeItem(STATS_KEY);alert("æ¶ˆã—ã¾ã—ãŸ");}
};

// =======================
// ====== åˆ†æ ======
// =======================
const SUBJECTS=[
{key:"history",label:"æ­´å²"},
{key:"geography",label:"åœ°ç†"},
{key:"science",label:"ç†ç§‘"},
{key:"art",label:"ç¾è¡“"},
{key:"music",label:"éŸ³æ¥½"},
{key:"pe",label:"ä¿å¥ä½“è‚²"},
{key:"tech",label:"æŠ€è¡“"},
];

function drawBar(canvas,items){
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const max=Math.max(1,...items.map(x=>x.value));
  const w=canvas.width/items.length;
  items.forEach((it,i)=>{
    const h=(it.value/max)*(canvas.height-40);
    ctx.fillStyle="#111";
    ctx.fillRect(i*w+10,canvas.height-h-20,w-20,h);
    ctx.fillText(it.value,i*w+10,canvas.height-h-25);
    ctx.fillStyle="#666";
    ctx.fillText(it.label.slice(0,6),i*w+10,canvas.height-5);
  });
}

els.analyticsBtn.onclick=async()=>{
  els.analyticsCard.style.display="none";
  els.analyticsStatus.textContent="é›†è¨ˆä¸­â€¦";

  const stats=loadStats();

  // æ•™ç§‘
  const bySubject=SUBJECTS.map(s=>{
    let total=0;
    allForSubject.forEach(q=>{
      if(q.subject===s.key){
        const st=stats[String(q.id||"")];
        if(st) total+=st.ok+st.ng;
      }
    });
    return {label:s.label,value:total};
  });
  drawBar(els.chartSubject,bySubject);

  // ç¯€
  const map={};
  allForSubject.forEach(q=>{
    const st=stats[String(q.id||"")];
    if(!st)return;
    const k=q.unit_section||"æœªè¨­å®š";
    if(!map[k]) map[k]=0;
    map[k]+=st.ok+st.ng;
  });
  const secItems=Object.entries(map).map(([k,v])=>({label:k,value:v}))
    .sort((a,b)=>b.value-a.value).slice(0,12);
  drawBar(els.chartSection,secItems);

  // ä¸å¾—æ„
  const weak=[];
  allForSubject.forEach(q=>{
    const st=stats[String(q.id||"")];
    if(st&&st.ng>0){
      weak.push({
        subject:q.subject,
        unit_big:q.unit_big,
        unit_section:q.unit_section,
        wrong:st.ng,
        attempts:st.ok+st.ng
      });
    }
  });
  weak.sort((a,b)=>b.wrong-a.wrong);
  if(weak.length===0){
    els.weakSections.innerHTML="ã¾ã ã‚ã‚Šã¾ã›ã‚“";
  }else{
    els.weakSections.innerHTML=`
    <table class="table">
    <tr><th>#</th><th>ç¯€</th><th>ä¸æ­£è§£</th></tr>
    ${weak.slice(0,20).map((w,i)=>`<tr>
      <td><span class="badge">${i+1}</span></td>
      <td>${w.unit_big} / ${w.unit_section}</td>
      <td>${w.wrong}</td>
    </tr>`).join("")}
    </table>`;
  }

  els.analyticsCard.style.display="";
  els.analyticsStatus.textContent="å®Œäº†ï¼";
};
</script>

</body>
</html>


