<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å®¶åº­å­¦ç¿’ã‚¯ã‚¤ã‚º</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; line-height: 1.5; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    label { display:block; margin: 8px 0 4px; font-weight: 600; }
    select, input[type="number"], textarea, button {
      width: 100%; font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc;
    }
    textarea { resize: vertical; }
    button { border: none; background: #111; color: #fff; margin-top: 10px; }
    button.secondary { background: #666; }
    button.danger { background:#b00020; }
    button:disabled { background:#ccc; color:#777; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .muted { color:#666; font-size: 13px; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; margin-right:6px; }
    .choices button { background:#f3f3f3; color:#111; border:1px solid #ddd; margin: 8px 0; text-align:left; }
    hr { border:none; border-top:1px solid #eee; margin:12px 0; }

    /* ====== æ­£è§£/ä¸æ­£è§£ï¼ˆå¤§ãããƒ»ç›®ç«‹ã¤ï¼‰ ====== */
    .ok {
      color: #00c853;
      font-weight: 900;
      font-size: 34px;
      letter-spacing: 0.5px;
      text-shadow: 0 0 14px rgba(0, 200, 83, 0.35);
    }
    .ng {
      color: #ff1744;
      font-weight: 900;
      font-size: 26px;
      letter-spacing: 0.5px;
      text-shadow: 0 0 12px rgba(255, 23, 68, 0.25);
    }

    /* ====== æ¼”å‡ºï¼ˆå…‰ã‚‹ãƒ»ãƒãƒƒãƒ—ï¼‰ ====== */
    @keyframes pop {
      0%   { transform: scale(0.9); opacity: 0.3; }
      60%  { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1.0); }
    }
    @keyframes glowOk {
      0% { box-shadow: 0 0 0 rgba(0,200,83,0.0); }
      40% { box-shadow: 0 0 22px rgba(0,200,83,0.35); }
      100% { box-shadow: 0 0 0 rgba(0,200,83,0.0); }
    }
    @keyframes glowNg {
      0% { box-shadow: 0 0 0 rgba(255,23,68,0.0); }
      40% { box-shadow: 0 0 22px rgba(255,23,68,0.28); }
      100% { box-shadow: 0 0 0 rgba(255,23,68,0.0); }
    }
    .fx-ok { animation: pop 420ms ease-out, glowOk 700ms ease-out; border-radius: 12px; padding: 6px 10px; }
    .fx-ng { animation: pop 420ms ease-out, glowNg 700ms ease-out; border-radius: 12px; padding: 6px 10px; }

    /* ====== é€£ç¶šæ­£è§£ ====== */
    .streak { margin-top: 6px; font-weight: 800; font-size: 18px; }
    .streak .fire { filter: drop-shadow(0 0 10px rgba(255,165,0,0.35)); }

    .hint { background:#fafafa; border:1px dashed #ddd; padding:10px; border-radius:10px; margin-top:10px; }

    /* ====== ç”»åƒè¡¨ç¤º ====== */
    .q-image-wrap { margin: 10px 0; }
    .q-image {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid #eee;
      display: block;
    }
    .q-image-caption {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>

<h2>å®¶åº­å­¦ç¿’ã‚¯ã‚¤ã‚º</h2>
<div class="muted">è‹¦æ‰‹ã»ã©å‡ºé¡Œé »åº¦ãŒä¸ŠãŒã‚Šã¾ã™ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰ã€‚</div>

<!-- è¨­å®š -->
<div class="card" id="setup">
  <label>ç§‘ç›®</label>
  <select id="subject">
    <option value="history">æ­´å²</option>
    <option value="geography">åœ°ç†</option>
    <option value="science">ç†ç§‘</option>
    <option value="art">ç¾è¡“</option>
    <option value="music">éŸ³æ¥½</option>
    <option value="pe">ä¿å¥ä½“è‚²</option>
    <option value="tech">æŠ€è¡“</option>
  </select>

  <div class="row">
    <div>
      <label>å¤§å˜å…ƒ</label>
      <select id="unitBig"></select>
    </div>
    <div>
      <label>ç¯€</label>
      <select id="unitSection"></select>
    </div>
  </div>

  <label>å‡ºé¡Œç¯„å›²</label>
  <select id="rangeMode">
    <option value="section" selected>ã“ã®ç¯€ã®ã¿</option>
    <option value="big">å¤§å˜å…ƒå…¨ä½“ï¼ˆç¯€ã‚’ã¾ãŸãï¼‰</option>
  </select>

  <div class="row">
    <div>
      <label>å•é¡Œæ•°</label>
      <input id="numQ" type="number" min="1" max="50" value="10" />
    </div>
    <div>
      <label>ã‚¿ã‚¤ãƒ—</label>
      <select id="typeFilter">
        <option value="">ã™ã¹ã¦</option>
        <option value="mcq">4æŠ</option>
        <option value="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</option>
        <option value="self">è‡ªå·±æ¡ç‚¹</option>
      </select>
    </div>
  </div>

  <label>å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</label>
  <select id="sessionMode">
    <option value="normal" selected>é€šå¸¸</option>
    <option value="wrongOnly">é–“é•ãˆãŸå•é¡Œã ã‘</option>
  </select>

  <label>è‹¦æ‰‹å„ªå…ˆ</label>
  <select id="weakMode">
    <option value="off">OFFï¼ˆå®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
    <option value="mid" selected>ONï¼ˆæ¨™æº–ï¼‰</option>
    <option value="strong">ONï¼ˆå¼·ã‚ï¼‰</option>
  </select>

  <label>æ¼”å‡º</label>
  <select id="fxMode">
    <option value="on" selected>ONï¼ˆåŠ¹æœéŸ³/å…‰ã‚‹/ãƒã‚¤ãƒ–/é€£ç¶šæ­£è§£ï¼‰</option>
    <option value="off">OFF</option>
  </select>

  <button id="startBtn">å‡ºé¡Œé–‹å§‹</button>
  <button class="secondary" id="reloadBtn">å˜å…ƒä¸€è¦§ã‚’å†èª­è¾¼</button>
  <button class="danger" id="resetStatsBtn">å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã“ã®ç«¯æœ«ï¼‰</button>

  <div class="muted" id="status"></div>
  <div class="muted" id="statsSummary"></div>

  <div class="hint muted">
    ã€Œé–“é•ãˆãŸå•é¡Œã ã‘ã€ãƒ¢ãƒ¼ãƒ‰ã¯ã€é€šå¸¸ã§è§£ã„ã¦ä¸æ­£è§£å±¥æ­´ï¼ˆÃ—ï¼‰ã‚’ä½œã‚‹ã¨åŠ¹ãã¾ã™ã€‚
  </div>
</div>

<!-- å‡ºé¡Œ -->
<div class="card" id="quiz" style="display:none;">
  <div id="progress" class="muted"></div>
  <div id="meta"></div>
  <h3 id="qText"></h3>

  <!-- ç”»åƒã¯ã“ã“ã«æŒ¿å…¥ -->

  <div id="mcqArea" class="choices" style="display:none;"></div>

  <div id="kwArea" style="display:none;">
    <label>å›ç­”ï¼ˆæ–‡ç« ã§OKï¼‰</label>
    <textarea id="kwInput" rows="3" placeholder="ã“ã“ã«å…¥åŠ›"></textarea>
    <button id="kwCheckBtn" disabled>æ¡ç‚¹ã™ã‚‹</button>
    <div class="muted">â€»å…¥åŠ›ãŒç©ºã®ã¨ãã¯æ¡ç‚¹ã§ãã¾ã›ã‚“</div>
  </div>

  <div id="selfArea" style="display:none;">
    <label>å›ç­”ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="selfInput" rows="3" placeholder="ã“ã“ã«å…¥åŠ›ï¼ˆä»»æ„ï¼‰"></textarea>
    <button id="selfRevealBtn">æ¨¡ç¯„è§£ç­”ãƒ»è§£èª¬ã‚’è¦‹ã‚‹</button>
    <div id="selfReveal" style="display:none; margin-top:10px;"></div>
    <div id="selfMark" style="display:none;">
      <button id="selfOkBtn">â—‹ï¼ˆæ­£è§£ï¼‰</button>
      <button class="secondary" id="selfNgBtn">Ã—ï¼ˆä¸æ­£è§£ï¼‰</button>
    </div>
  </div>

  <hr />
  <div id="feedback"></div>

  <button class="secondary" id="nextBtn" style="display:none;">æ¬¡ã®å•é¡Œ</button>
  <button class="secondary" id="quitBtn">ã‚„ã‚ã‚‹ï¼ˆçµæœã¸ï¼‰</button>
</div>

<!-- çµæœ -->
<div class="card" id="result" style="display:none;">
  <h3>çµæœ</h3>
  <div id="scoreLine"></div>
  <div id="review"></div>
  <button id="backBtn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
</div>

<script>
  // â˜…ã‚ãªãŸã®exec URLã«ç½®ãæ›ãˆ
  const API_BASE = "https://script.google.com/macros/s/AKfycbyVNfQjqvEJZAKv13SOULHAqLUk2WZEFRdotZBL_aRPQDYXdklTcSojvDrMndnI3qdGsw/exec";

  // =========================
  // å­¦ç¿’å±¥æ­´ï¼ˆç«¯æœ«å†…ï¼‰
  // =========================
  const STATS_KEY = "quiz_stats_v1"; // { [id]: {ok, ng, lastAt} }

  function loadStats() {
    try { return JSON.parse(localStorage.getItem(STATS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveStats(stats) {
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
  }
  function recordAttempt(q, ok) {
    const id = String(q.id ?? "");
    if (!id) return;
    const stats = loadStats();
    const cur = stats[id] || { ok: 0, ng: 0, lastAt: 0 };
    if (ok) cur.ok += 1; else cur.ng += 1;
    cur.lastAt = Date.now();
    stats[id] = cur;
    saveStats(stats);
  }
  function resetStats() {
    localStorage.removeItem(STATS_KEY);
  }

  function summarizeStatsForPool(pool) {
    const stats = loadStats();
    let seen = 0, ok = 0, ng = 0;
    let wrongQ = 0;
    for (const q of pool) {
      const id = String(q.id ?? "");
      const s = stats[id];
      if (!s) continue;
      seen += 1;
      ok += (s.ok || 0);
      ng += (s.ng || 0);
      if ((s.ng || 0) > 0) wrongQ += 1;
    }
    return { seen, ok, ng, wrongQ };
  }

  function isWrongQuestion(q) {
    const id = String(q.id ?? "");
    if (!id) return false;
    const s = loadStats()[id];
    return !!(s && (s.ng || 0) > 0);
  }

  function weightForQuestion(q, mode) {
    if (mode === "off") return 1;

    const stats = loadStats();
    const id = String(q.id ?? "");
    const s = stats[id] || { ok: 0, ng: 0, lastAt: 0 };

    const ok = Number(s.ok || 0);
    const ng = Number(s.ng || 0);
    const total = ok + ng;

    const wrongRate = total > 0 ? (ng / total) : 0;

    const recentHours = (Date.now() - (s.lastAt || 0)) / 36e5;
    const recentBoost = (ng > 0 && recentHours <= 24) ? 0.4 : 0;

    const k = (mode === "strong") ? 3.0 : 2.0;
    const b = (mode === "strong") ? 1.3 : 1.1;

    const w = 1 + k * wrongRate + b * Math.min(5, ng) / 5 + recentBoost;
    return Math.max(0.2, w);
  }

  function sampleWeightedUnique(pool, n, mode) {
    const items = pool.map(q => ({ q, w: weightForQuestion(q, mode) }));
    const picked = [];
    const N = Math.min(n, items.length);

    for (let i = 0; i < N; i++) {
      const sum = items.reduce((a, x) => a + x.w, 0);
      let r = Math.random() * sum;
      let idx = -1;
      for (let j = 0; j < items.length; j++) {
        r -= items[j].w;
        if (r <= 0) { idx = j; break; }
      }
      if (idx < 0) idx = items.length - 1;
      picked.push(items[idx].q);
      items.splice(idx, 1);
    }
    return picked;
  }

  // =========================
  // UI
  // =========================
  const els = {
    subject: document.getElementById('subject'),
    unitBig: document.getElementById('unitBig'),
    unitSection: document.getElementById('unitSection'),
    rangeMode: document.getElementById('rangeMode'),
    numQ: document.getElementById('numQ'),
    typeFilter: document.getElementById('typeFilter'),
    sessionMode: document.getElementById('sessionMode'),
    weakMode: document.getElementById('weakMode'),
    fxMode: document.getElementById('fxMode'),
    startBtn: document.getElementById('startBtn'),
    reloadBtn: document.getElementById('reloadBtn'),
    resetStatsBtn: document.getElementById('resetStatsBtn'),
    status: document.getElementById('status'),
    statsSummary: document.getElementById('statsSummary'),

    setup: document.getElementById('setup'),
    quiz: document.getElementById('quiz'),
    result: document.getElementById('result'),

    progress: document.getElementById('progress'),
    meta: document.getElementById('meta'),
    qText: document.getElementById('qText'),

    mcqArea: document.getElementById('mcqArea'),

    kwArea: document.getElementById('kwArea'),
    kwInput: document.getElementById('kwInput'),
    kwCheckBtn: document.getElementById('kwCheckBtn'),

    selfArea: document.getElementById('selfArea'),
    selfInput: document.getElementById('selfInput'),
    selfRevealBtn: document.getElementById('selfRevealBtn'),
    selfReveal: document.getElementById('selfReveal'),
    selfMark: document.getElementById('selfMark'),
    selfOkBtn: document.getElementById('selfOkBtn'),
    selfNgBtn: document.getElementById('selfNgBtn'),

    feedback: document.getElementById('feedback'),
    nextBtn: document.getElementById('nextBtn'),
    quitBtn: document.getElementById('quitBtn'),

    scoreLine: document.getElementById('scoreLine'),
    review: document.getElementById('review'),
    backBtn: document.getElementById('backBtn'),
  };

  let allForSubject = [];
  let quizList = [];
  let idx = 0;
  let correct = 0;
  let results = [];
  let isAnswered = false;

  let streak = 0;
  let bestStreak = 0;

  function show(el, on) { el.style.display = on ? "" : "none"; }

  function qs(params) {
    const u = new URL(API_BASE);
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && String(v).trim() !== "") u.searchParams.set(k, v);
    });
    u.searchParams.set("_t", Date.now().toString());
    return u.toString();
  }

  function fetchJSONP(url) {
    return new Promise((resolve, reject) => {
      const cbName = "jsonp_cb_" + Math.random().toString(36).slice(2);
      const u = new URL(url);
      u.searchParams.set("callback", cbName);

      const script = document.createElement("script");
      script.src = u.toString();

      window[cbName] = (data) => { cleanup(); resolve(data); };
      script.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };

      function cleanup() { delete window[cbName]; script.remove(); }
      document.body.appendChild(script);
    });
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function uniqSortUnits(items) {
    const map = new Map();
    for (const it of items) {
      const name = (it.unit_big ?? "").toString().trim();
      if (!name) continue;
      const order = Number(it.unit_big_order);
      if (!map.has(name)) map.set(name, {name, order: Number.isFinite(order) ? order : 9999});
    }
    return Array.from(map.values())
      .sort((a,b) => a.order - b.order || a.name.localeCompare(b.name,'ja'))
      .map(x => x.name);
  }

  function uniqSortSections(items, unitBig) {
    const map = new Map();
    for (const it of items) {
      const big = (it.unit_big ?? "").toString().trim();
      if (big !== unitBig) continue;
      const sec = (it.unit_section ?? "").toString().trim();
      if (!sec) continue;
      const order = Number(it.unit_section_order);
      if (!map.has(sec)) map.set(sec, {sec, order: Number.isFinite(order) ? order : 9999});
    }
    return Array.from(map.values())
      .sort((a,b) => a.order - b.order || a.sec.localeCompare(b.sec,'ja'))
      .map(x => x.sec);
  }

  async function loadCatalog() {
    els.status.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    const subject = els.subject.value;

    const json = await fetchJSONP(qs({ subject }));
    allForSubject = json.data || [];

    const unitBigs = uniqSortUnits(allForSubject);
    els.unitBig.innerHTML = unitBigs.length
      ? unitBigs.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("")
      : `<option value="">ï¼ˆå•é¡Œãªã—ï¼‰</option>`;

    const firstBig = unitBigs[0] || "";
    const sections = uniqSortSections(allForSubject, firstBig);
    els.unitSection.innerHTML = sections.length
      ? sections.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("")
      : `<option value="">ï¼ˆç¯€ãªã—ï¼‰</option>`;

    els.status.textContent = `èª­ã¿è¾¼ã¿å®Œäº†ï¼š${json.count}ä»¶ï¼ˆç§‘ç›®=${subject}ï¼‰`;
    refreshStatsSummary();
  }

  function currentPool() {
    const subject = els.subject.value;
    const unitBig = els.unitBig.value;
    const unitSection = els.unitSection.value;
    const type = els.typeFilter.value;
    const rangeMode = els.rangeMode.value;

    let pool = allForSubject.filter(q =>
      String(q.subject||"").toLowerCase() === subject &&
      String(q.unit_big||"").trim() === unitBig
    );
    if (rangeMode === "section") {
      pool = pool.filter(q => String(q.unit_section||"").trim() === unitSection);
    }
    if (type) pool = pool.filter(q => String(q.type||"").toLowerCase() === type);
    return pool;
  }

  function refreshStatsSummary() {
    const pool = currentPool();
    if (pool.length === 0) { els.statsSummary.textContent = ""; return; }

    const sum = summarizeStatsForPool(pool);
    const rangeLabel = (els.rangeMode.value === "big") ? "å¤§å˜å…ƒå…¨ä½“" : "ã“ã®ç¯€ã®ã¿";
    const wrongOnly = (els.sessionMode.value === "wrongOnly") ? "ï¼ˆé–“é•ãˆãŸå•é¡Œã ã‘ï¼‰" : "";

    els.statsSummary.textContent =
      `ç¯„å›²ï¼š${rangeLabel}${wrongOnly} / å¯¾è±¡ï¼š${pool.length}å• / å­¦ç¿’æ¸ˆã¿ï¼š${sum.seen}å•ï¼ˆæ­£è§£${sum.ok}ãƒ»ä¸æ­£è§£${sum.ng}ï¼‰ / é–“é•ã„ã®ã‚ã‚‹å•é¡Œï¼š${sum.wrongQ}å•`;
  }

  // â˜…ã“ã“ãŒä»Šå›ã®é‡è¦ä¿®æ­£ï¼šç¢ºå®Ÿã«æ¶ˆãˆã‚‹å‰Šé™¤å‡¦ç†ï¼ˆdata-qimgï¼‰
  function removeQuestionImage() {
    document.querySelectorAll('[data-qimg="1"]').forEach(e => e.remove());
  }

  function resetQuizUI() {
    isAnswered = false;
    removeQuestionImage();

    els.feedback.innerHTML = "";
    show(els.nextBtn, false);
    show(els.mcqArea, false);
    show(els.kwArea, false);
    show(els.selfArea, false);

    els.kwInput.value = "";
    els.kwInput.disabled = false;
    els.kwCheckBtn.disabled = true;
    els.kwCheckBtn.textContent = "æ¡ç‚¹ã™ã‚‹";

    els.selfInput.value = "";
    els.selfInput.disabled = false;
    els.selfReveal.innerHTML = "";
    show(els.selfReveal, false);
    show(els.selfMark, false);
    els.selfRevealBtn.disabled = false;
    els.selfRevealBtn.textContent = "æ¨¡ç¯„è§£ç­”ãƒ»è§£èª¬ã‚’è¦‹ã‚‹";
    els.selfOkBtn.disabled = false;
    els.selfNgBtn.disabled = false;
  }

  function lockAfterAnswered(type) {
    isAnswered = true;

    if (type === "keyword") {
      els.kwCheckBtn.disabled = true;
      els.kwInput.disabled = true;
      els.kwCheckBtn.textContent = "æ¡ç‚¹æ¸ˆã¿";
    }

    if (type === "self") {
      els.selfRevealBtn.disabled = true;
      els.selfOkBtn.disabled = true;
      els.selfNgBtn.disabled = true;
      els.selfInput.disabled = true;
      els.selfRevealBtn.textContent = "æ¡ç‚¹æ¸ˆã¿";
    }
  }

  function showAnswerBlock(q) {
    const ans = (q.answer ?? "").toString();
    const exp = (q.explanation ?? "").toString();
    let html = "";
    if (ans) html += `<div><strong>æ¨¡ç¯„è§£ç­”ï¼š</strong>${escapeHtml(ans)}</div>`;
    if (exp) html += `<div style="margin-top:6px;"><strong>è§£èª¬ï¼š</strong>${escapeHtml(exp)}</div>`;
    return html || `<div class="muted">ï¼ˆæ¨¡ç¯„è§£ç­”/è§£èª¬ãŒæœªå…¥åŠ›ã§ã™ï¼‰</div>`;
  }

  function normalizeUrl(u) {
    return String(u || "").trim();
  }

  // ç”»åƒã‚’æŒ¿å…¥ï¼ˆã‚ã‚Œã°ï¼‰ â€»data-qimg ã‚’ä»˜ã‘ã‚‹
  function insertQuestionImage(q) {
    const url = normalizeUrl(q.image_url);
    if (!url) return;

    removeQuestionImage(); // å¿µã®ãŸã‚äºŒé‡é˜²æ­¢
    const caption = String(q.image_caption || "").trim();

    const html =
      `<div class="q-image-wrap" data-qimg="1">
         <img class="q-image" src="${escapeHtml(url)}" alt="å•é¡Œç”»åƒ" loading="lazy">
         ${caption ? `<div class="q-image-caption">${escapeHtml(caption)}</div>` : ``}
       </div>`;

    els.qText.insertAdjacentHTML("afterend", html);
  }

  function renderQuestion(q) {
    resetQuizUI();

    els.progress.textContent = `å•é¡Œ ${idx + 1} / ${quizList.length}`;
    els.meta.innerHTML =
      `<span class="pill">${escapeHtml(q.subject || "")}</span>` +
      `<span class="pill">${escapeHtml(q.unit_big || "")}</span>` +
      `<span class="pill">${escapeHtml(q.unit_section || "")}</span>` +
      (q.tags ? `<span class="pill">${escapeHtml(q.tags)}</span>` : "");

    els.qText.textContent = String(q.question || "");

    // ç”»åƒè¡¨ç¤ºï¼ˆimage_urlãŒã‚ã‚Œã°ï¼‰
    insertQuestionImage(q);

    const type = String(q.type || "").toLowerCase();

    if (type === "mcq") {
      show(els.mcqArea, true);
      const choices = [
        ["A", q.choice_a],
        ["B", q.choice_b],
        ["C", q.choice_c],
        ["D", q.choice_d]
      ].filter(([,v]) => String(v||"").trim() !== "");

      els.mcqArea.innerHTML = choices.map(([k,v]) =>
        `<button data-k="${k}"><strong>${k}.</strong> ${escapeHtml(v)}</button>`
      ).join("");

      els.mcqArea.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          if (isAnswered) return;
          const picked = btn.getAttribute("data-k");
          gradeMCQ(q, picked);
        }, { once: true });
      });

    } else if (type === "keyword") {
      show(els.kwArea, true);

      els.kwInput.oninput = () => {
        if (isAnswered) return;
        els.kwCheckBtn.disabled = els.kwInput.value.trim().length === 0;
      };

      els.kwCheckBtn.onclick = () => {
        if (isAnswered) return;
        gradeKeyword(q);
      };

    } else {
      show(els.selfArea, true);

      els.selfRevealBtn.onclick = () => {
        if (isAnswered) return;
        revealSelf(q);
      };

      els.selfOkBtn.onclick = () => {
        if (isAnswered) return;
        markSelf(q, true);
      };

      els.selfNgBtn.onclick = () => {
        if (isAnswered) return;
        markSelf(q, false);
      };
    }
  }

  // =========================
  // æ¼”å‡ºï¼ˆåŠ¹æœéŸ³/å…‰ã‚‹/ãƒã‚¤ãƒ–/é€£ç¶šæ­£è§£ï¼‰
  // =========================
  function fxOn() { return els.fxMode.value !== "off"; }

  function vibrate(pattern) {
    if (!fxOn()) return;
    if (navigator && typeof navigator.vibrate === "function") {
      try { navigator.vibrate(pattern); } catch {}
    }
  }

  let audioCtx = null;
  function beep(freq, durationMs, type = "sine", gain = 0.06) {
    if (!fxOn()) return;
    try {
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();

      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);

      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + durationMs / 1000);

      osc.connect(g);
      g.connect(audioCtx.destination);

      osc.start(t0);
      osc.stop(t0 + durationMs / 1000 + 0.02);
    } catch {}
  }

  function soundOk() {
    beep(880, 90, "sine", 0.07);
    setTimeout(() => beep(1175, 110, "sine", 0.07), 110);
  }
  function soundNg() {
    beep(220, 140, "triangle", 0.06);
  }

  function applyFx(ok) {
    if (!fxOn()) return;
    els.feedback.classList.remove("fx-ok", "fx-ng");
    void els.feedback.offsetWidth;
    els.feedback.classList.add(ok ? "fx-ok" : "fx-ng");
  }

  function streakHtml() {
    const fire = streak >= 3 ? " ğŸ”¥" : "";
    return `<div class="streak"><span class="fire">é€£ç¶šæ­£è§£ï¼š${streak}${fire}</span>ï¼ˆæœ€é«˜ï¼š${bestStreak}ï¼‰</div>`;
  }

  function afterGrade(q, ok, type) {
    results.push({ ok, q: q.question, unit_big: q.unit_big, unit_section: q.unit_section });
    if (ok) correct++;

    recordAttempt(q, ok);
    lockAfterAnswered(type);

    if (ok) {
      streak += 1;
      bestStreak = Math.max(bestStreak, streak);
    } else {
      streak = 0;
    }

    show(els.nextBtn, true);
    els.nextBtn.onclick = next;
  }

  function gradeMCQ(q, picked) {
    const correctKey = String(q.correct||"").trim().toUpperCase();
    const ok = picked === correctKey;

    applyFx(ok);
    if (ok) { soundOk(); vibrate([20, 30, 20]); }
    else { soundNg(); vibrate([80]); }

    els.feedback.innerHTML =
      `<div>${ok ? `<span class="ok">ğŸ‰ æ­£è§£ï¼</span>` : `<span class="ng">âœ— ä¸æ­£è§£</span>`}</div>` +
      `<div class="muted">ï¼ˆã‚ãªãŸï¼š${picked} / æ­£è§£ï¼š${correctKey || "?"}ï¼‰</div>` +
      streakHtml() +
      `<div style="margin-top:10px;">${showAnswerBlock(q)}</div>`;

    afterGrade(q, ok, "mcq");
  }

  function gradeKeyword(q) {
    const input = els.kwInput.value || "";
    const kws = String(q.keywords||"").split(",").map(s => s.trim()).filter(Boolean);
    const need = Number(q.keyword_min || 1);
    const hit = kws.filter(k => input.includes(k)).length;
    const ok = hit >= (Number.isFinite(need) ? need : 1);

    applyFx(ok);
    if (ok) { soundOk(); vibrate([20, 30, 20]); }
    else { soundNg(); vibrate([80]); }

    els.feedback.innerHTML =
      `<div>${ok ? `<span class="ok">ğŸ‰ æ­£è§£ï¼</span>` : `<span class="ng">âœ— ä¸æ­£è§£</span>`}</div>` +
      `<div class="muted">ä¸€è‡´ï¼š${hit} / å¿…è¦ï¼š${need}</div>` +
      (kws.length ? `<div class="muted">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${escapeHtml(kws.join(" / "))}</div>` : "") +
      streakHtml() +
      `<div style="margin-top:10px;">${showAnswerBlock(q)}</div>`;

    afterGrade(q, ok, "keyword");
  }

  function revealSelf(q) {
    els.selfReveal.innerHTML = showAnswerBlock(q);
    show(els.selfReveal, true);
    show(els.selfMark, true);
  }

  function markSelf(q, ok) {
    applyFx(ok);
    if (ok) { soundOk(); vibrate([20, 30, 20]); }
    else { soundNg(); vibrate([80]); }

    els.feedback.innerHTML =
      `<div>${ok ? `<span class="ok">ğŸ‰ æ­£è§£ï¼</span>` : `<span class="ng">âœ— ä¸æ­£è§£</span>`}</div>` +
      streakHtml();

    afterGrade(q, ok, "self");
  }

  function next() {
    idx++;
    if (idx >= quizList.length) return showResult();
    renderQuestion(quizList[idx]);
  }

  function showResult() {
    show(els.setup, false);
    show(els.quiz, false);
    show(els.result, true);

    els.scoreLine.innerHTML =
      `<div><strong>${correct} / ${quizList.length}</strong>ï¼ˆæ­£ç­”ç‡ ${(correct/quizList.length*100).toFixed(0)}%ï¼‰</div>` +
      `<div class="muted">æœ€é«˜é€£ç¶šæ­£è§£ï¼š${bestStreak}</div>`;

    const wrongs = results.filter(r => !r.ok);
    if (wrongs.length === 0) {
      els.review.innerHTML = `<div class="ok">ğŸ‰ å…¨å•æ­£è§£ï¼</div>`;
    } else {
      els.review.innerHTML =
        `<div class="ng">é–“é•ã„ï¼š${wrongs.length}å•</div>` +
        `<ol>${wrongs.map(w => `<li>${escapeHtml(w.unit_big||"")} / ${escapeHtml(w.unit_section||"")}ï¼š${escapeHtml(w.q||"")}</li>`).join("")}</ol>`;
    }
  }

  function startQuiz() {
    let pool = currentPool();
    const n = Math.max(1, Math.min(50, Number(els.numQ.value || 10)));
    const mode = els.weakMode.value;
    const sessionMode = els.sessionMode.value;

    if (pool.length === 0) {
      alert("ã“ã®æ¡ä»¶ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å•é¡Œã‚’è¿½åŠ ã™ã‚‹ã‹ã€æ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚");
      return;
    }

    if (sessionMode === "wrongOnly") {
      const wrongPool = pool.filter(isWrongQuestion);
      if (wrongPool.length === 0) {
        alert("ã“ã®ç¯„å›²ã§ã¯ã€Œé–“é•ãˆãŸå•é¡Œã€ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§è§£ã„ã¦å±¥æ­´ã‚’ä½œã£ã¦ãã ã•ã„ã€‚");
        return;
      }
      pool = wrongPool;
    }

    quizList = sampleWeightedUnique(pool, n, mode);

    idx = 0;
    correct = 0;
    results = [];
    streak = 0;
    bestStreak = 0;

    show(els.setup, false);
    show(els.result, false);
    show(els.quiz, true);

    renderQuestion(quizList[0]);
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  els.reloadBtn.onclick = () => loadCatalog().catch(e => els.status.textContent = "èª­è¾¼å¤±æ•—ï¼š" + e.message);
  els.subject.onchange = () => loadCatalog().catch(e => els.status.textContent = "èª­è¾¼å¤±æ•—ï¼š" + e.message);

  els.unitBig.onchange = () => {
    const big = els.unitBig.value;
    const sections = uniqSortSections(allForSubject, big);
    els.unitSection.innerHTML = sections.length
      ? sections.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("")
      : `<option value="">ï¼ˆç¯€ãªã—ï¼‰</option>`;
    refreshStatsSummary();
  };

  els.unitSection.onchange = refreshStatsSummary;
  els.typeFilter.onchange = refreshStatsSummary;
  els.weakMode.onchange = refreshStatsSummary;
  els.rangeMode.onchange = refreshStatsSummary;
  els.sessionMode.onchange = refreshStatsSummary;

  els.startBtn.onclick = startQuiz;

  els.quitBtn.onclick = showResult;
  els.backBtn.onclick = () => {
    show(els.result,false);
    show(els.quiz,false);
    show(els.setup,true);
    refreshStatsSummary();
  };

  els.resetStatsBtn.onclick = () => {
    if (!confirm("ã“ã®ç«¯æœ«ã®å­¦ç¿’å±¥æ­´ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    resetStats();
    refreshStatsSummary();
    alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
  };

  loadCatalog().catch(e => els.status.textContent = "åˆæœŸèª­è¾¼å¤±æ•—ï¼š" + e.message);
</script>

</body>
</html>

